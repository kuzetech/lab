## 项目目的
本项目旨在读取用户指定的文件，并 将文件内容发送到 Apache Pulsar 的指定主题中

## 项目依赖
- java 11
- maven 3.9
- pulsar 4.0.1
- mysql 8.0

## 功能特性
- 用户可以通过命令行参数或者配置环境变量来指定文件路径、Pulsar 连接信息和目标主题
- 读取文件格式为日志文件，以 .log 结尾，文件大小不超过 10MB
- 读取文件内容，当累计到一定的行数时，通过事务将批次数据发送到 Pulsar 主题
- 通过 mysql 存储文件偏移量和事务状态，确保程序重启后可以从上次中断的位置继续发送数据
- 支持错误处理和重试机制，确保消息发送的可靠性
- 提供详细的日志记录，方便用户进行问题排查和性能分析

## 代码实现要求
- 请不要修改本文件
- 使用 Maven 进行项目管理
- 使用 Lombok 简化 Java 代码编写
- 请使用一张 MySQL 数据库表存储每一批数据的文件偏移量和事务状态，表结构自行设计
- 脚本都放置在 [scripts](scripts) 目录下
- 在 [run.sh](scripts%2Frun.sh) 中实现项目快速测试


## 技术方案
### EOS 实现方案
当积攒一批数据后，发送流程如下：
- 先创建事务，然后将本批次的起始偏移量、结束偏移量，事务id，及事务状态 pending 写入数据库
- 发送批次消息到 Pulsar 主题
- 提交 Pulsar 事务
- 更新数据库中该事务状态为 committed

如果在发送流程中出现异常导致程序重启，启动时应先查询数据库中是否存在 pending 状态的记录
- 如果没有，则从数据库中最后一次提交的偏移量继续读取文件发送数据
- 如果有，则说明上次发送过程中出现异常未能完成提交操作，此时需要根据该 pending 记录的事务id 并使用 pulsar admin api 查询事务状态
  - 如果状态为已提交，依次完成以下事项
    - 更新该事务状态为 committed
    - 从结束偏移量继续处理数据
  - 如果状态为已取消，依次完成以下事项
    - 更新该事务状态为 canceled
    - 从起始偏移量重新读取数据
    - 积攒一批数据后执行发送流程
  - 如果状态为待提交，依次完成以下事项
    - 通过 pulsar admin api 取消该事务
    - 更新该事务状态为 canceled
    - 从起始偏移量重新读取数据
    - 积攒一批数据后执行发送流程
  - 其他情况下，打印相关日志并终止程序运行

## 快速测试
- 使用 [test-data-gen.sh](scripts%2Ftest-data-gen.sh) 脚本生成测试数据文件
- 使用 [docker-compose.yml](docker-compose.yml) 快速启动 pulsar 和 mysql 测试环境
- 运行 [Main.java](src%2Fmain%2Fjava%2Fcom%2Fkuzetech%2Fbigdata%2Fpulsar%2Feos%2FMain.java) 主程序快速测试
